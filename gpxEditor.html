<!DOCTYPE html>
<html lang="en">  
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GPX 文件编辑器</title>
    <!-- 引入 Leaflet CSS 和 JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
      crossorigin=""
    ></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap');
        :root {
            --bg: #f7efe5;
            --panel: #f3e7d9;
            --card: #f0e3d6;
            --muted: #6b5d53;
            --accent: #0ea5e9;
            --accent-strong: #d97757;
            --border: #d4c4b5;
            --shadow: 0 16px 40px rgba(0, 0, 0, 0.18);
        }
        .no-select {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: 'Manrope', 'Segoe UI', sans-serif;
            background: radial-gradient(circle at 20% 20%, #fdf7f0 0%, #f6ecdf 35%, #f2e3d4 65%, #eed9c7 100%);
            color: #2f2a25;
        }
        /* 左侧容器 */
        .left-panel {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(4px);
        }
        /* 标题和说明 */
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .header h1 {
            margin: 0;
            font-size: 26px;
            letter-spacing: 0.2px;
        }
        .header p {
            margin: 0;
            font-size: 14px;
            color: var(--muted);
            flex: 1;
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }
        /* 按钮容器 */
        .button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        button {
            font-family: inherit;
            font-size: 14px;
            border: 1px solid transparent;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            color: #1f1b17;
            background: #f4ede6;
            transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.16);
        }
        button:hover {
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }
        /* 色彩快速应用 */
        #exportBtn, #centerBtn { background: var(--accent); color: #0b1021; border-color: rgba(255,255,255,0.08); }
        #addWptBtn { background: #22c55e; color: #0b1021; border-color: rgba(255,255,255,0.08); }
        #clearBtn { background: #f87171; color: #0b1021; border-color: rgba(255,255,255,0.08); }
        #helpBtn { background: var(--accent-strong); color: #0b1021; border-color: rgba(255,255,255,0.08); }
        #importBtn { background: #22c55e; color: #0b1021; }
        #copyCurrentBtn { background: var(--accent); color: #0b1021; }
        #setStartBtn { background: #f87171; color: #0b1021; }
        #setEndBtn { background: #22c55e; color: #0b1021; }
        #deleteIntermediateBtn { background: #fbbf24; color: #0b1021; }

        /* 地图容器 */
        #map {
            width: 100%;
            flex-grow: 1;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        /* 信息容器 */
        .info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,0.7), rgba(255,255,255,0.45));
            box-shadow: var(--shadow);
        }
        .info-group {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .info-item {
            margin: 0;
            min-width: 140px;
        }
        .info-item p {
            margin: 0;
            font-size: 14px;
        }
        .info-item .label { font-weight: 700; }
        .info-item .description { font-size: 12px; color: var(--muted); }

        /* 右侧轨迹点列表 */
        .right-panel {
            width: 320px;
            padding: 18px;
            overflow-y: auto;
            box-sizing: border-box;
            border-left: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(4px);
            box-shadow: inset 1px 0 0 rgba(255,255,255,0.3);
        }
        .right-panel h2 {
            margin-top: 0;
            font-size: 20px;
            font-weight: 700;
        }
        .right-panel p {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            margin-bottom: 12px;
        }
        .right-panel ul {
            margin: 0;
            padding: 0;
            list-style: none;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .right-panel ul li {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .right-panel ul li:last-child { border-bottom: none; }
        .right-panel ul li:hover { background-color: rgba(255,255,255,0.04); }
        .right-panel ul li.bg-blue-200 { background-color: rgba(14,165,233,0.18); }
        textarea {
            background: var(--card);
            color: #2f2a25;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        /* 地图标记样式 */
        .marker-start {
            background-color: yellow;
            border: 2px solid gray;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        .marker-end {
            background-color: white;
            border: 2px solid black;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        .marker-selected-start {
            background-color: green;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        .marker-selected-end {
            background-color: red;
            border: 2px solid white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        /* 说明弹窗 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff8f0;
            border: 1px solid var(--border);
            max-width: 520px;
            width: 90%;
            padding: 18px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-size: 14px;
            line-height: 1.5;
            color: #2f2a25;
        }
        .modal h3 { margin: 0 0 8px 0; font-size: 18px; }
        .modal ul { padding-left: 18px; margin: 8px 0; color: var(--muted); }
        .modal button { margin-top: 12px; padding: 8px 14px; }
    </style>
</head>
<body>
    <!-- 左侧：地图和控件 -->
    <div class="left-panel">
        <!-- 标题和键盘控制说明 -->
        <div class="header">
            <h1>GPX 文件编辑器</h1>
            <p>控制: 拖动点微调, 点击线插点, 选中点后设为红/绿点可批量删除区间, Ctrl+Z 撤销</p>
            <button id="helpBtn" style="margin-left: 12px; background: #0ea5e9; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">使用说明</button>
        </div>
        <!-- 文件选择和导出按钮 -->
        <div class="button-container">
            <input type="file" id="gpxFileInput" accept=".gpx" />
            <button id="exportBtn" class="button" style="margin-right: 8px;">导出GPX 文件</button>
            <button id="addWptBtn" class="button" style="margin-right: 8px; background-color: #10b981; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">添加标记</button>
            <button id="centerBtn" class="button" style="margin-right: 8px; background-color: #6366f1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">居中显示</button>
            <button id="clearBtn" class="button" style="background-color: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">清除全部</button>
        </div>
        <!-- 地图 -->
        <div id="map"></div>
        <!-- 底部信息 -->
        <div class="info-container">
            <div class="info-group">
                <div class="info-item">
                    <p class="label">起始序号(红)：<span id="startValue">1</span></p>
                    <button id="setStartBtn" style="margin-top: 4px; background-color: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">设为起点</button>
                    <p class="description">[ ] 减增</p>
                </div>
                <div class="info-item">
                    <p class="label">结束序号(绿)：<span id="endValue">1</span></p>
                    <button id="setEndBtn" style="margin-top: 4px; background-color: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">设为终点</button>
                    <p class="description">; ' 减增</p>
                </div>
                <div class="info-item">
                    <p class="label" id="selectedDistance">选定路径长度: 0 千米</p>
                    <button id="deleteIntermediateBtn" style="margin-top: 4px; background-color: #f59e0b; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">删除区间内中间点</button>
                </div>
            </div>
            <p class="label" id="totalDistance">路径总长度: 0 千米</p>
        </div>
    </div>
    <!-- 右侧：轨迹点列表 -->
    <div class="right-panel">
        <h2>轨迹点列表</h2>
        <p>, . 切换轨迹点</p>
        <ul id="trkptList"></ul>
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
            <h3>批量粘贴/复制</h3>
            <textarea id="batchInput" rows="10" style="width: 100%; box-sizing: border-box; font-family: monospace; font-size: 12px; padding: 5px;" placeholder="粘贴坐标列表，例如：
31.840726, 117.259387
31.842093, 117.259371"></textarea>
            <button id="importBtn" style="width: 100%; margin-top: 8px; padding: 8px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px;">从文本导入轨迹</button>
            <button id="copyCurrentBtn" style="width: 100%; margin-top: 8px; padding: 8px; cursor: pointer; background: #2196F3; color: white; border: none; border-radius: 4px;">复制当前轨迹到文本框</button>
        </div>
    </div>
    <!-- 使用说明弹窗 -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal">
            <h3>使用说明</h3>
            <ul>
                <li>导入/导出：选择 GPX 文件或点击“导出GPX 文件”保存当前轨迹与标记。</li>
                <li>轨迹编辑：拖动蓝线上的点微调；点击线可插入新点；Backspace 删除选中点；Ctrl+Z 撤销。</li>
                <li>区间操作：用“设为起点/终点”标记区间，点击“删除区间内中间点”批量删除。</li>
                <li>标记点：点击“添加标记”在地图中心放置橙色标记，可拖动、改名、删除；标记随 GPX 导入/导出。</li>
                <li>居中显示：点击“居中显示”让地图适配当前轨迹。</li>
                <li>批量导入：在右侧文本框粘贴坐标列表（lat, lon），点击“从文本导入轨迹”。</li>
                <li>快捷键：[, ] 调整起点索引；; ' 调整终点索引；, . 在列表中上一/下一点。</li>
            </ul>
            <button id="helpCloseBtn" style="background: #4b5563; color: white; border: none; border-radius: 4px;">关闭</button>
        </div>
    </div>
    <!-- 脚本部分 -->
    <script>
        let map;
        let tianDiTuLabelLayer;
        let tianDiTutk='65b19d8b660b4c26d7921c3764efeb92'; // 请到 http://lbs.tianditu.gov.cn/home.html 申请并更换成自己的token
        // 默认加载的轨迹点
        let trkpts = [];
        let wpts = []; // 特殊标记点
        let wptMarkers = []; // 标记点的地图标记
        // 自定义颜色的标准图钉样式
        const waypointIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
            shadowSize: [41, 41],
            shadowAnchor: [12, 41]
        });
        let history = [];
        let selectedIndex = null;
        let isFirstLoad = true;
        let routeStartMarker, routeEndMarker;
        let selectedStartMarker, selectedEndMarker;
        let pointMarkers = []; // 存储所有点的标记

        let startIndex = 1;
        let endIndex = 1;

        document.getElementById('gpxFileInput').addEventListener('change', handleFileUpload);
        document.getElementById('exportBtn').addEventListener('click', exportGPX);
        document.getElementById('importBtn').addEventListener('click', importFromText);
        document.getElementById('copyCurrentBtn').addEventListener('click', copyToTextarea);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('centerBtn').addEventListener('click', centerMap);
        document.getElementById('deleteIntermediateBtn').addEventListener('click', deleteIntermediatePoints);
        document.getElementById('addWptBtn').addEventListener('click', addWaypointAtCenter);
        document.getElementById('helpBtn').addEventListener('click', openHelp);
        document.getElementById('helpCloseBtn').addEventListener('click', closeHelp);
        document.getElementById('setStartBtn').addEventListener('click', () => {
            if (selectedIndex !== null) {
                startIndex = selectedIndex + 1;
                updateIndices();
            } else {
                alert('请先在地图或列表中选中一个点');
            }
        });
        document.getElementById('setEndBtn').addEventListener('click', () => {
            if (selectedIndex !== null) {
                endIndex = selectedIndex + 1;
                updateIndices();
            } else {
                alert('请先在地图或列表中选中一个点');
            }
        });
        document.addEventListener('keydown', handleKeyDown);

        function openHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }

        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // 点击蒙层关闭
        document.getElementById('helpModal').addEventListener('click', (e) => {
            if (e.target.id === 'helpModal') {
                closeHelp();
            }
        });

        function deleteIntermediatePoints() {
            let sIndex = startIndex - 1;
            let eIndex = endIndex - 1;
            
            if (eIndex - sIndex <= 1) {
                alert('选定区间内没有中间点可以删除。');
                return;
            }

            if (confirm(`确定要删除第 ${startIndex + 1} 到第 ${endIndex - 1} 个点吗？`)) {
                saveHistory();
                // 删除 sIndex + 1 到 eIndex - 1 之间的点
                const count = eIndex - sIndex - 1;
                trkpts.splice(sIndex + 1, count);
                
                // 选中起始点，方便后续“重新规划”插入点
                selectedIndex = sIndex;
                
                drawRoute();
                displayTrkpts();
                updateIndices();
                calculateTotalDistance();
                calculateSelectedDistance();
            }
        }

        function centerMap() {
            if (trkpts.length > 0) {
                const latlngs = trkpts.map(pt => [pt.lat, pt.lon]);
                map.fitBounds(latlngs);
            }
        }

        function saveHistory() {
            history.push(JSON.stringify(trkpts));
            if (history.length > 50) history.shift(); // 最多保留50步
        }

        function undo() {
            if (history.length > 0) {
                trkpts = JSON.parse(history.pop());
                drawRoute();
                displayTrkpts();
                updateIndices();
                calculateTotalDistance();
                calculateSelectedDistance();
            }
        }

        function clearAll() {
            if (confirm('确定要清除所有轨迹点和标记吗？')) {
                saveHistory();
                trkpts = [];
                wpts = [];
                selectedIndex = null;
                drawRoute();
                drawWaypoints();
                displayTrkpts();
                updateIndices();
                calculateTotalDistance();
                calculateSelectedDistance();
            }
        }

        // --- 标记功能 ---
        function addWaypointAtCenter() {
            if (!map) return;
            const center = map.getCenter();
            const name = `标记 ${wpts.length + 1}`;
            wpts.push({ lat: center.lat, lon: center.lng, name });
            drawWaypoints();
        }

        function drawWaypoints() {
            if (!map) return;
            wptMarkers.forEach(m => map.removeLayer(m));
            wptMarkers = [];

            wpts.forEach((wpt, index) => {
                const marker = L.marker([wpt.lat, wpt.lon], {
                    draggable: true,
                    title: wpt.name,
                    icon: waypointIcon
                }).addTo(map);

                const popupContent = document.createElement('div');
                popupContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <input type="text" value="${wpt.name}" id="wptNameInput-${index}" style="padding: 4px;">
                        <div style="display: flex; gap: 6px;">
                            <button onclick="saveWaypointName(${index})" style="background: #3b82f6; color: white; border: none; padding: 4px; cursor: pointer; flex: 1;">保存</button>
                            <button onclick="deleteWaypoint(${index})" style="background: #ef4444; color: white; border: none; padding: 4px; cursor: pointer; flex: 1;">删除</button>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);

                marker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    wpts[index].lat = pos.lat;
                    wpts[index].lon = pos.lng;
                });

                wptMarkers.push(marker);
            });
        }

        window.saveWaypointName = function(index) {
            const input = document.getElementById(`wptNameInput-${index}`);
            if (input) {
                wpts[index].name = input.value;
                drawWaypoints();
                map.closePopup();
            }
        };

        window.deleteWaypoint = function(index) {
            if (confirm(`确定删除标记 "${wpts[index].name}" 吗？`)) {
                wpts.splice(index, 1);
                drawWaypoints();
                map.closePopup();
            }
        };

        function importFromText() {
            const text = document.getElementById('batchInput').value;
            const lines = text.split('\n');
            const newPts = [];
            // 匹配格式如: 31.840726, 117.259387 或 (31.840726, 117.259387)
            const coordRegex = /([-+]?\d*\.\d+|\d+)\s*[,，\s]\s*([-+]?\d*\.\d+|\d+)/;

            lines.forEach(line => {
                const match = line.match(coordRegex);
                if (match) {
                    newPts.push({
                        lat: parseFloat(match[1]),
                        lon: parseFloat(match[2])
                    });
                }
            });

            if (newPts.length > 0) {
                trkpts = newPts;
                selectedIndex = trkpts.length - 1;
                isFirstLoad = true; // 重新缩放地图以适应新轨迹
                drawRoute();
                displayTrkpts();
                updateIndices();
                calculateTotalDistance();
                calculateSelectedDistance();
                alert(`成功导入 ${newPts.length} 个点`);
            } else {
                alert('未识别到有效的坐标格式，请确保每行包含：纬度, 经度');
            }
        }

        function copyToTextarea() {
            const text = trkpts.map(pt => `${pt.lat.toFixed(6)}, ${pt.lon.toFixed(6)}`).join('\n');
            document.getElementById('batchInput').value = text;
            document.getElementById('batchInput').select();
            alert('已将当前轨迹点填入文本框，你可以直接复制。');
        }

        // 初始化地图和显示默认轨迹点
        window.onload = function() {
            initMap();
            displayTrkpts();
            updateIndices();
            calculateTotalDistance();
            calculateSelectedDistance();
            if (trkpts.length > 0) {
                selectTrkptItem(trkpts.length - 1);
            }
        };

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "application/xml");
                    parseGPX(xmlDoc);
                    drawRoute();
                    displayTrkpts();
                    updateIndices();
                    calculateTotalDistance();
                    calculateSelectedDistance();
                    if (trkpts.length > 0) {
                        selectTrkptItem(trkpts.length - 1);
                    }
                };
                reader.readAsText(file);
            }
        }

        function parseGPX(xmlDoc) {
            trkpts = [];
            wpts = [];
            const trkptElements = xmlDoc.getElementsByTagName('trkpt');
            for (let i = 0; i < trkptElements.length; i++) {
                const lat = parseFloat(trkptElements[i].getAttribute('lat'));
                const lon = parseFloat(trkptElements[i].getAttribute('lon'));
                trkpts.push({ lat, lon });
            }

            const wptElements = xmlDoc.getElementsByTagName('wpt');
            for (let i = 0; i < wptElements.length; i++) {
                const lat = parseFloat(wptElements[i].getAttribute('lat'));
                const lon = parseFloat(wptElements[i].getAttribute('lon'));
                let name = `标记 ${i + 1}`;
                const nameTag = wptElements[i].getElementsByTagName('name')[0];
                if (nameTag) name = nameTag.textContent;
                wpts.push({ lat, lon, name });
            }
            startIndex = 1;
            endIndex = trkpts.length > 0 ? trkpts.length : 1;

            drawWaypoints();
        }
        
        function initMap() {  
            if (!map) {
                const tianDiTuVectorLayer = L.tileLayer('http://t{s}.tianditu.gov.cn/vec_w/wmts?' +  
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&' +  
                    'TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&' +  
                    'tk='+tianDiTutk, {   
                    subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],  
                    maxZoom: 18,  
                    minZoom: 1,  
                    attribution: '地图数据 © 天地图'  
                });  

                tianDiTuLabelLayer = L.tileLayer('http://t{s}.tianditu.gov.cn/cva_w/wmts?' +  
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&' +  
                    'TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&' +  
                    'tk='+tianDiTutk, {    
                    subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],  
                    maxZoom: 18,  
                    minZoom: 1,  
                    attribution: '地图数据 © 天地图'  
                });  

                const tianDiTuSatelliteLayer = L.tileLayer('http://t{s}.tianditu.gov.cn/img_w/wmts?' +  
                    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&' +  
                    'TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&' +  
                    'tk='+tianDiTutk, {  
                    subdomains: ['0', '1', '2', '3', '4', '5', '6', '7'],  
                    maxZoom: 18,  
                    minZoom: 1,  
                    attribution: '地图数据 © 天地图'  
                });  

                map = L.map('map', {  
                    center: [31.840726, 117.259387],  
                    zoom: 15,  
                    layers: [tianDiTuVectorLayer, tianDiTuLabelLayer] // 默认加载矢量图层和标注图层  
                });  

                const baseLayers = {
                    "天地图标准地图": tianDiTuVectorLayer,  
                    "天地图卫星影像": tianDiTuSatelliteLayer  
                };  

                const overlayLayers = {  
                    "天地图标注": tianDiTuLabelLayer  
                };  

                L.control.layers(baseLayers, overlayLayers).addTo(map);  
                
                map.on('click', onMapClick);
            }
            drawRoute();
            updateMarkers();
            }
            
        function drawRoute() {
            // 移除现有的路线
            if (window.routeLine) {
                map.removeLayer(window.routeLine);
            }

            // 移除所有点标记
            pointMarkers.forEach(m => map.removeLayer(m));
            pointMarkers = [];

            // 移除起点和终点标记
            if (routeStartMarker) {
                map.removeLayer(routeStartMarker);
            }
            if (routeEndMarker) {
                map.removeLayer(routeEndMarker);
            }

            if (trkpts.length > 0) {
                const latlngs = trkpts.map(pt => [pt.lat, pt.lon]);
                window.routeLine = L.polyline(latlngs, { color: 'blue', weight: 5 }).addTo(map);
                
                if (isFirstLoad) {
                    map.fitBounds(latlngs);
                    isFirstLoad = false;
                }

                // 为每个点添加一个小标记，使其可拖动
                trkpts.forEach((pt, index) => {
                    const marker = L.circleMarker([pt.lat, pt.lon], {
                        radius: 4,
                        color: '#3b82f6',
                        fillColor: '#fff',
                        fillOpacity: 1,
                        interactive: true,
                        draggable: true // 注意：circleMarker 默认不支持 draggable，我们需要手动处理
                    }).addTo(map);

                    // 手动实现拖拽逻辑
                    let isDragging = false;
                    marker.on('mousedown', function(e) {
                        isDragging = true;
                        map.dragging.disable();
                        saveHistory();
                    });

                    map.on('mousemove', function(e) {
                        if (isDragging) {
                            marker.setLatLng(e.latlng);
                            trkpts[index].lat = e.latlng.lat;
                            trkpts[index].lon = e.latlng.lng;
                            // 实时更新线
                            window.routeLine.setLatLngs(trkpts.map(p => [p.lat, p.lon]));
                        }
                    });

                    map.on('mouseup', function() {
                        if (isDragging) {
                            isDragging = false;
                            map.dragging.enable();
                            displayTrkpts();
                            calculateTotalDistance();
                            calculateSelectedDistance();
                            updateSelectedMarkers();
                        }
                    });

                    marker.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        selectTrkptItem(index);
                    });

                    pointMarkers.push(marker);
                });

                // 添加起点和终点标记 (装饰用)
                const startPt = trkpts[0];
                const endPt = trkpts[trkpts.length - 1];

                routeStartMarker = L.circleMarker([startPt.lat, startPt.lon], {
                    radius: 6,
                    color: 'gray',
                    fillColor: 'yellow',
                    fillOpacity: 1,
                    interactive: false
                }).addTo(map);

                routeEndMarker = L.circleMarker([endPt.lat, endPt.lon], {
                    radius: 6,
                    color: 'black',
                    fillColor: 'white',
                    fillOpacity: 1,
                    interactive: false
                }).addTo(map);
            }

            // 重绘标记点
            drawWaypoints();
        }

        function updateMarkers() {
            // 移除现有的标记
            if (window.currentMarker) {
                map.removeLayer(window.currentMarker);
            }
            if (selectedIndex !== null && trkpts[selectedIndex]) {
                const pt = trkpts[selectedIndex];
                window.currentMarker = L.marker([pt.lat, pt.lon]).addTo(map);
                //map.panTo([pt.lat, pt.lon]);
            }
        }

        function displayTrkpts() {
            const trkptList = document.getElementById('trkptList');
            trkptList.innerHTML = '';
            trkpts.forEach((pt, index) => {
                const li = document.createElement('li');
                li.className = "cursor-pointer";
                li.innerText = `(${pt.lat.toFixed(6)}, ${pt.lon.toFixed(6)})`;
                li.index = index;
                li.tabIndex = 0; // 使列表项可聚焦
                li.addEventListener('click', function() {
                    selectTrkptItem(this.index);
                });
                trkptList.appendChild(li);
            });

            // 确保高亮显示当前选中的项
            if (selectedIndex !== null && trkpts[selectedIndex]) {
                selectTrkptItem(selectedIndex);
            }
        }

        function selectTrkptItem(index) {
            selectedIndex = index;
            const items = document.querySelectorAll('#trkptList li');
            items.forEach((item, idx) => {
                if (idx === index) {
                    item.classList.add('bg-blue-200');
                    item.focus(); // 聚焦到选中的项
                } else {
                    item.classList.remove('bg-blue-200');
                }
            });
            updateMarkers();
        }

        function handleKeyDown(e) {
            // 在输入框/文本域中输入时，不拦截按键（允许 Backspace 等编辑操作）
            const activeTag = document.activeElement && document.activeElement.tagName;
            if (activeTag === 'INPUT' || activeTag === 'TEXTAREA') {
                return;
            }

            // Ctrl + Z 撤销
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
                return;
            }

            if (selectedIndex !== null) {
                if (e.key === 'Backspace') {
                    e.preventDefault();
                    saveHistory();
                    trkpts.splice(selectedIndex, 1); // 删除选中的点
                    selectedIndex = trkpts.length > 0 ? Math.max(0, selectedIndex - 1) : null;
                    drawRoute();
                    displayTrkpts();
                    updateIndices();
                    calculateTotalDistance();
                    calculateSelectedDistance();
                } else if (e.key === ',' || e.key === '<') {
                    // 选择上一项
                    e.preventDefault();
                    if (selectedIndex > 0) {
                        selectTrkptItem(selectedIndex - 1);
                        scrollIntoViewIfNeeded();
                    }
                } else if (e.key === '.' || e.key === '>') {
                    // 选择下一项
                    e.preventDefault();
                    if (selectedIndex < trkpts.length - 1) {
                        selectTrkptItem(selectedIndex + 1);
                        scrollIntoViewIfNeeded();
                    }
                }
            }

            // 控制起始和结束序号
            if (e.key === '[') {
                // 减少起始序号
                if (startIndex > 1) {
                    startIndex--;
                    updateIndices();
                    calculateSelectedDistance();
                    updateSelectedMarkers();
                }
            } else if (e.key === ']') {
                // 增加起始序号
                if (startIndex < trkpts.length && startIndex < endIndex - 1) {
                    startIndex++;
                    updateIndices();
                    calculateSelectedDistance();
                    updateSelectedMarkers();
                }
            } else if (e.key === ';') {
                // 减少结束序号
                if (endIndex > startIndex + 1) {
                    endIndex--;
                    updateIndices();
                    calculateSelectedDistance();
                    updateSelectedMarkers();
                }
            } else if (e.key === "'") {
                // 增加结束序号
                if (endIndex < trkpts.length) {
                    endIndex++;
                    updateIndices();
                    calculateSelectedDistance();
                    updateSelectedMarkers();
                }
            }

            // 地图控制键
            const panOffset = 100; // 地图移动的像素值
            switch (e.key) {
                case 'w':
                case 'W':
                    map.panBy([0, -panOffset]);
                    break;
                case 'a':
                case 'A':
                    map.panBy([-panOffset, 0]);
                    break;
                case 's':
                case 'S':
                    map.panBy([0, panOffset]);
                    break;
                case 'd':
                case 'D':
                    map.panBy([panOffset, 0]);
                    break;
                case '+':
                case '=':
                    map.zoomIn();
                    break;
                case '-':
                    map.zoomOut();
                    break;
                default:
                    break;
            }
        }

        function scrollIntoViewIfNeeded() {
            const item = document.querySelectorAll('#trkptList li')[selectedIndex];
            item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
        }

        // 寻找距离点击位置最近的线段索引
        function findNearestSegment(latlng) {
            let minDistance = Infinity;
            let segmentIndex = -1;
            const clickPoint = map.latLngToLayerPoint(latlng);

            for (let i = 0; i < trkpts.length - 1; i++) {
                const p1 = map.latLngToLayerPoint([trkpts[i].lat, trkpts[i].lon]);
                const p2 = map.latLngToLayerPoint([trkpts[i+1].lat, trkpts[i+1].lon]);
                
                const distance = L.LineUtil.pointToSegmentDistance(clickPoint, p1, p2);
                if (distance < minDistance) {
                    minDistance = distance;
                    segmentIndex = i;
                }
            }
            // 只有当点击距离线条足够近时才认为是点击了线条（例如 20 像素内）
            return minDistance < 20 ? segmentIndex : -1;
        }

        function onMapClick(e) {
            // 1. 检查是否点击了现有点附近（选中逻辑）
            let closestIndex = -1;
            let minDistance = 15;

            trkpts.forEach((pt, index) => {
                const point = map.latLngToLayerPoint([pt.lat, pt.lon]);
                const clickPoint = map.latLngToLayerPoint(e.latlng);
                const distance = point.distanceTo(clickPoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = index;
                }
            });

            if (closestIndex !== -1) {
                selectTrkptItem(closestIndex);
                return;
            }

            // 2. 检查是否点击了线条中间（插点逻辑）
            const segmentIndex = findNearestSegment(e.latlng);
            if (segmentIndex !== -1) {
                saveHistory();
                const newPoint = { lat: e.latlng.lat, lon: e.latlng.lng };
                trkpts.splice(segmentIndex + 1, 0, newPoint);
                selectedIndex = segmentIndex + 1;
                drawRoute();
                displayTrkpts();
                updateIndices();
                calculateTotalDistance();
                calculateSelectedDistance();
                return;
            }

            // 3. 普通点击（根据当前选中位置插入或追加）
            saveHistory();
            const newPoint = { lat: e.latlng.lat, lon: e.latlng.lng };
            
            if (selectedIndex !== null && selectedIndex < trkpts.length - 1) {
                // 如果选中的不是最后一个点，则在选中点后插入（实现“重新规划中间段”）
                trkpts.splice(selectedIndex + 1, 0, newPoint);
                selectedIndex = selectedIndex + 1;
            } else {
                // 否则追加到末尾
                trkpts.push(newPoint);
                selectedIndex = trkpts.length - 1;
            }

            drawRoute();
            displayTrkpts();
            updateIndices();
            calculateTotalDistance();
            calculateSelectedDistance();
        }

        function calculateTotalDistance() {
            let totalDistance = 0;
            for (let i = 1; i < trkpts.length; i++) {
                const pt1 = L.latLng(trkpts[i - 1].lat, trkpts[i - 1].lon);
                const pt2 = L.latLng(trkpts[i].lat, trkpts[i].lon);
                totalDistance += pt1.distanceTo(pt2);
            }
            const totalDistanceKm = totalDistance / 1000;
            document.getElementById('totalDistance').innerText = `路径总长度: ${totalDistanceKm.toFixed(2)} 千米`;
        }

        function updateIndices() {
            const startValue = document.getElementById('startValue');
            const endValue = document.getElementById('endValue');

            const maxIndex = trkpts.length;

            // 确保起始和结束序号在有效范围内
            if (startIndex > maxIndex) {
                startIndex = maxIndex;
            }
            if (endIndex > maxIndex) {
                endIndex = maxIndex;
            }
            if (startIndex < 1) {
                startIndex = 1;
            }
            if (endIndex < 1) {
                endIndex = 1;
            }

            // 确保 startIndex 总是小于 endIndex
            if (startIndex >= endIndex) {
                startIndex = endIndex - 1;
                if (startIndex < 1) {
                    startIndex = 1;
                    endIndex = 2;
                }
            }

            startValue.innerText = startIndex;
            endValue.innerText = endIndex;

            calculateSelectedDistance();
            updateSelectedMarkers();
        }

        function calculateSelectedDistance() {
            let sIndex = startIndex - 1;
            let eIndex = endIndex - 1;

            if (isNaN(sIndex) || isNaN(eIndex)) {
                document.getElementById('selectedDistance').innerText = '选定路径长度: 0 千米';
                return;
            }

            if (sIndex < 0 || eIndex < 0 || sIndex >= trkpts.length || eIndex >= trkpts.length) {
                document.getElementById('selectedDistance').innerText = '选定路径长度: 0 千米';
                return;
            }

            let selectedDistance = 0;
            for (let i = sIndex + 1; i <= eIndex; i++) {
                const pt1 = L.latLng(trkpts[i - 1].lat, trkpts[i - 1].lon);
                const pt2 = L.latLng(trkpts[i].lat, trkpts[i].lon);
                selectedDistance += pt1.distanceTo(pt2);
            }
            const selectedDistanceKm = selectedDistance / 1000;
            document.getElementById('selectedDistance').innerText = `选定路径长度: ${selectedDistanceKm.toFixed(2)} 千米`;
        }

        function updateSelectedMarkers() {
            let sIndex = startIndex - 1;
            let eIndex = endIndex - 1;

            if (isNaN(sIndex) || isNaN(eIndex)) {
                return;
            }

            if (sIndex < 0 || eIndex < 0 || sIndex >= trkpts.length || eIndex >= trkpts.length) {
                return;
            }

            // 移除之前的标记
            if (selectedStartMarker) {
                map.removeLayer(selectedStartMarker);
            }
            if (selectedEndMarker) {
                map.removeLayer(selectedEndMarker);
            }

            const startPt = trkpts[sIndex];
            const endPt = trkpts[eIndex];

            selectedStartMarker = L.circleMarker([startPt.lat, startPt.lon], {
                radius: 6,
                color: 'red',
                fillColor: 'red',
                fillOpacity: 1,
                interactive: false
            }).addTo(map);

            selectedEndMarker = L.circleMarker([endPt.lat, endPt.lon], {
                radius: 6,
                color: 'green',
                fillColor: 'green',
                fillOpacity: 1,
                interactive: false
            }).addTo(map);
        }

        document.getElementById('exportBtn').addEventListener('click', exportGPX);

        function exportGPX() {
            const xmlDoc = document.implementation.createDocument('', 'gpx', null);
            const gpx = xmlDoc.documentElement;
            gpx.setAttribute('version', '1.1');
            gpx.setAttribute('creator', 'GPX File Editor');
            gpx.setAttribute('xmlns', 'http://www.topografix.com/GPX/1/1');

            // 导出标记点
            wpts.forEach(wpt => {
                const wptEl = xmlDoc.createElement('wpt');
                wptEl.setAttribute('lat', wpt.lat);
                wptEl.setAttribute('lon', wpt.lon);
                const nameEl = xmlDoc.createElement('name');
                nameEl.textContent = wpt.name;
                wptEl.appendChild(nameEl);
                gpx.appendChild(wptEl);
            });

            const trk = xmlDoc.createElement('trk');
            const trkseg = xmlDoc.createElement('trkseg');
            trkpts.forEach(pt => {
                const trkpt = xmlDoc.createElement('trkpt');
                trkpt.setAttribute('lat', pt.lat);
                trkpt.setAttribute('lon', pt.lon);
                const ele = xmlDoc.createElement('ele');
                ele.textContent = '0';
                const speed = xmlDoc.createElement('Speed');
                trkpt.appendChild(ele);
                trkpt.appendChild(speed);
                trkseg.appendChild(trkpt);
            });
            trk.appendChild(trkseg);
            gpx.appendChild(trk);

            const serializer = new XMLSerializer();
            const gpxString = serializer.serializeToString(xmlDoc);

            const blob = new Blob([gpxString], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'route.gpx';
            link.click();
            URL.revokeObjectURL(url);
        }
  </script>
    <script>window.parent.postMessage({ action: "ready" }, "*"); 
 
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});
</script></body>
</html>